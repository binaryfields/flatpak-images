app-id: com.visualstudio.VSCode
branch: stable
command: code
base: io.atom.electron.BaseApp
base-version: stable
runtime: org.freedesktop.Sdk
runtime-version: 18.08
sdk: org.freedesktop.Sdk
separate-locales: false
finish-args: 
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
  - --talk-name=org.freedesktop.Flatpak
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.secrets
  - --env=NPM_CONFIG_GLOBALCONFIG=/app/etc/npmrc
modules: 
  - name: nodejs
    cleanup: 
      - /include 
      - /share
      - /app/lib/node_modules/npm/changelogs 
      - /app/lib/node_modules/npm/doc
      - /app/lib/node_modules/npm/html 
      - /app/lib/node_modules/npm/man
      - /app/lib/node_modules/npm/scripts
    sources: 
      - type: archive
        url: https://nodejs.org/dist/v8.11.2/node-v8.11.2.tar.xz
        sha256: 539946c0381809576bed07424a35fc1740d52f4bd56305d6278d9e76c88f4979
  
  - name: vscode
    buildsystem: simple
    build-commands:
      - install -D apply_extra /app/bin/apply_extra
      - install -D code.sh /app/bin/code
      - install -Dm644 com.visualstudio.VSCode.desktop /app/share/applications/com.visualstudio.VSCode.desktop
      - install -Dm644 com.visualstudio.VSCode.png /app/share/icons/hicolor/128x128/apps/com.visualstudio.VSCode.png
      - install -Dm644 com.visualstudio.VSCode-64.png /app/share/icons/hicolor/64x64/apps/com.visualstudio.VSCode.png
      - install -Dm644 npmrc /app/etc/npmrc
    sources:
      - type: script
        dest-filename: apply_extra
        commands: 
          - tar xf vscode.tar.gz
          - rm vscode.tar.gz
          - mv VSCode-* vscode
          - install -Dm644 /app/share/applications/com.visualstudio.VSCode.desktop export/share/applications/com.visualstudio.VSCode.desktop
      
      - type: script
        dest-filename: code.sh
        commands: 
          - exec env PATH=$PATH:$HOME/.local/bin:$XDG_DATA_HOME/node_modules/bin /app/extra/vscode/bin/code --extensions-dir=$XDG_DATA_HOME/vscode/extensions $@
      
      - type: file
        path: com.visualstudio.VSCode.desktop
      
      - type: file
        path: com.visualstudio.VSCode.png
      
      - type: file
        path: com.visualstudio.VSCode-64.png
      
      - type: file
        path: npmrc
      
      - type: extra-data
        filename: vscode.tar.gz
        only-arches: [x86_64]
        url: https://vscode-update.azurewebsites.net/1.26.1/linux-x64/stable
        sha256: 5ef2f82e1272b0008a446fc8f62f9693e2af7c83d5922883ecbfd8a9986fd40b
        size: 69775652
